Привет!
В моей CRM-системе bulk‑обновление посещаемости реализовано следующим образом:
При нажатии кнопки «Отметить всех» вызывается функция handleBulkAttendance в файле attendance‑2.tsx, которая через bulkAttendanceMutation отправляет запрос POST на эндпоинт /api/attendance/bulk.
На сервере в обработчике этого запроса вызывается метод storage.updateBulkAttendance, который для каждого студента группы проверяет наличие записи за указанную дату и либо обновляет её, либо вставляет новую запись.
После выполнения bulk‑операции в onSuccess вызывается invalidateQueries с ключом:
[
  "/api/attendance",
  selectedGroup?.id,
  selectedMonth.getMonth() + 1,
  selectedMonth.getFullYear(),
]
Проблема:
При нажатии на кнопку «Отметить всех» bulk‑операция, похоже, проходит (данные в БД обновляются), но обновление UI не происходит мгновенно – изменения появляются только после дополнительного клика по ячейке, который вызывает повторный GET-запрос.
Я предполагаю, что это может быть связано с тремя возможными причинами:
Пустой ответ от bulk‑эндпоинта:
Сейчас сервер возвращает res.sendStatus(200), что не возвращает валидный JSON. Возможно, это мешает корректному завершению мутации.
InvalidateQueries не инициирует рефетч:
Из-за настроек кэширования или staleTime (хотя он и выставлен корректно) React Query не делает повторный запрос, если данные считаются «свежими». Может помочь принудительный вызов refetchQueries.
Формат даты:
Возможно, формат сравнения даты в методе updateBulkAttendance не совпадает с тем, что хранится в базе, что приводит к тому, что обновляются не все записи или создаются дубли.
Пожалуйста, внеси следующие изменения:
В обработчике эндпоинта /api/attendance/bulk в серверном коде (файл routes‑2.ts) замени:
res.sendStatus(200);
на:

res.status(200).json({ success: true });
чтобы возвращался корректный JSON-ответ.
В onSuccess мутации bulkAttendanceMutation в файле attendance‑2.tsx замени вызов invalidateQueries на принудительный рефетч:
queryClient.refetchQueries({
  queryKey: [
    "/api/attendance",
    selectedGroup?.id,
    selectedMonth.getMonth() + 1,
    selectedMonth.getFullYear(),
  ],
  exact: true,
});
Добавь временные console.log в метод storage.updateBulkAttendance для проверки:
Выводи id студента и дату, для которой ищется запись.
Выводи результат запроса на существующую запись (existingAttendance).
Это поможет убедиться, что для каждого студента происходит обновление или вставка записи, и что формат даты совпадает с тем, что хранится в базе.
Эти изменения должны обеспечить мгновенное обновление UI после bulk‑операции без необходимости дополнительного клика.
Пожалуйста, сгенерируй необходимый код или внеси правки в существующий код для решения этой проблемы.
Спасибо!